# Hardware API

## Common provisions

#### Terminology

The terminology of [RFC 2119](https://www.ietf.org/rfc/rfc2119.txt) (specifically __must__, __should__, __may__ and their negatives) applies.  The word __will__, when applied to the Hardware Service API ("the API"), has the same meaning as __must__.

#### Protocol

The API supports communication over HTTPS only.

#### Encoding

The API supports communication using JSON encoding only.  The client __must__ submit the headers `Content-Type: application/json` and `Accept: application/json` for all requests.  Failure to do so __will__ result in a `415 Unsupported Media Type` response.  The API __will__ include the header `Content-Type: application/json` with its response.

#### Authentication

The API is authenticated by a JWT bearer token.  Two token sources are accepted:

* Tokens generated by Amazon Cognito and acquired from the [`accessory/login`](#Login) endpoint;
* Tokens generated by Amazon Cognito and acquired as part of authentication to the Users Service;
* Tokens returned from the Website service's `/token` endpoint as the value of the `access_token` property.  See the documentation at [/Website/README.md#Oauth]().

The client __must__ submit the header `Authorization: <JWT>` with all requests. Failure to do so, or submitting an invalid or expired JWT, __will__ result in a `401 Unauthorized` response.  

#### General responses

In addition to the AWS API Gateway responses and the specific responses for each endpoint, the server __may__ respond with one of the following HTTP responses:

* `400 Bad Request` with `Status` header equal to `InvalidSchema`, if the JSON body of the request does not match the requirements of the endpoint.
* `404 Unknown` with `Status` header equal to `UnknownEndpoint`, if an invalid endpoint was requested.

## Schema

### Simple

The following simple types __may__ be used in responses:

* `string`, `number`: as defined in the [JSON Schema](http://json-schema.org) standard.

## Endpoints

### Accessory

#### Register

This endpoint can be called to register a new accessory.

##### Query String
 
The client __must__ submit a request to the endpoint `/accessory/{mac_address}/register`, where `mac_address` __must__ be a MacAddress. It __should__ correspond to the MAC Address of the accessory.

##### Request

The client __must__ submit a request body containing a JSON object with the following schema:

```
{
    "password": String,
    "hardware_model": String,
    "firmware_version": String,
    "settings_key": String
}
```

* `password` __must__ be a string containing 8 or more characters, with no leading or trailing spaces.
* `hardware_model` __must__ be a string of between 1 and 256 characters.  It __should__ uniquely identify the hardware model of the accessory.  This value is immutable.
* `firmware_version` __must__ be a VersionNumber, which __should__ identify the version of the firmware installed on the accessory.
* `settings_key` __must__ be a string of between 1 and 256 characters.

```
POST /v1/accessory/1d:3a:42:5d:g5:ea/register HTTP/1.1
Host: hardware.env.fathomai.com
Content-Type: application/json
Authorization: ...

{
    "password": "ffqkjhrqdkha2",
    "hardwareModel": "Model T",
    "firmwareVersion": "1.0",
    "settingsKey": "123456"
}

```

##### Responses
 
If the registration was successful, the Service __will__ respond with HTTP Status `201 Created`.
 
If the request was not successful, the Service __may__ respond with:

 * `419 Conflict` with `Status` header equal to `DuplicateMacAddress`, if an accessory with that MAC address has already been registered.
